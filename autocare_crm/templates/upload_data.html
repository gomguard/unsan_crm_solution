{% extends 'base.html' %}

{% block title %}데이터 업로드 - Unsan CRM solution{% endblock %}

{% block content %}
<!-- 페이지 헤더 -->
<div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
    <div>
        <h1 class="text-2xl font-bold text-gray-900 flex items-center">
            <i class="bi bi-upload mr-2"></i>
            데이터 업로드
            <span class="ml-2 text-sm font-normal text-gray-500">고객 정보 가져오기</span>
        </h1>
    </div>
    <div class="mt-4 sm:mt-0">
        <a href="{% url 'customer_list' %}" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors">
            <i class="bi bi-people mr-2"></i>
            고객 목록으로
        </a>
    </div>
</div>

<!-- 업로드 안내 -->
<div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
    <div class="flex items-start">
        <i class="bi bi-info-circle-fill text-blue-600 text-xl mr-3 mt-0.5"></i>
        <div>
            <h3 class="text-sm font-medium text-blue-900 mb-2">업로드 안내</h3>
            <ul class="text-sm text-blue-800 space-y-1">
                <li>• 지원 형식: <strong>Excel (.xlsx, .xls)</strong> 및 <strong>CSV (.csv)</strong></li>
                <li>• 최대 파일 크기: <strong>10MB</strong></li>
                <li>• 휴대전화 + 차량번호 조합으로 고객을 구분합니다</li>
                <li>• 기존 고객 정보는 자동으로 업데이트됩니다</li>
                <li>• 검사만료일이 자동으로 분석되어 우선순위가 설정됩니다</li>
            </ul>
        </div>
    </div>
</div>

<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- 파일 업로드 폼 -->
    <div class="lg:col-span-2">
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h2 class="text-lg font-medium text-gray-900">
                    <i class="bi bi-file-earmark-arrow-up mr-2"></i>파일 업로드
                </h2>
            </div>
            <div class="p-6">
                <form method="post" enctype="multipart/form-data" id="uploadForm">
                    {% csrf_token %}
                    
                    <!-- 드래그 앤 드롭 영역 -->
                    <div class="mb-6">
                        <label for="{{ form.file.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-2">
                            파일 선택
                        </label>
                        <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-gray-300 border-dashed rounded-lg hover:border-primary transition-colors cursor-pointer" id="dropZone">
                            <div class="space-y-1 text-center">
                                <i class="bi bi-cloud-arrow-up text-4xl text-gray-400"></i>
                                <div class="flex text-sm text-gray-600">
                                    <label for="{{ form.file.id_for_label }}" class="relative cursor-pointer rounded-md font-medium text-primary hover:text-primary-hover">
                                        <span>파일을 선택하거나</span>
                                    </label>
                                    <p class="pl-1">여기에 드래그하세요</p>
                                </div>
                                <p class="text-xs text-gray-500">Excel 또는 CSV (최대 10MB)</p>
                            </div>
                        </div>
                        {{ form.file }}
                        <div id="fileInfo" class="mt-2 text-sm text-gray-600 hidden"></div>
                        {% if form.file.errors %}
                            <div class="mt-2 text-sm text-red-600">
                                {% for error in form.file.errors %}
                                    {{ error }}
                                {% endfor %}
                            </div>
                        {% endif %}
                    </div>

                    <!-- 업로드 옵션 -->
                    <div class="mb-6 space-y-3">
                        <h3 class="text-sm font-medium text-gray-700">업로드 옵션</h3>
                        <label class="flex items-center">
                            <input type="checkbox" name="update_existing" checked
                                   class="rounded border-gray-300 text-primary focus:ring-primary mr-2">
                            <span class="text-sm text-gray-700">기존 고객 정보 업데이트</span>
                            <span class="ml-2 text-xs text-gray-500">(체크 해제 시 중복 고객은 건너뜁니다)</span>
                        </label>
                        <label class="flex items-center">
                            <input type="checkbox" name="auto_tags" checked
                                   class="rounded border-gray-300 text-primary focus:ring-primary mr-2">
                            <span class="text-sm text-gray-700">자동 태그 및 우선순위 설정</span>
                            <span class="ml-2 text-xs text-gray-500">(검사만료, 단골고객 등 자동 분류)</span>
                        </label>
                    </div>

                    <!-- 업로드 버튼 -->
                    <button type="submit" id="uploadBtn"
                            class="w-full inline-flex items-center justify-center px-6 py-3 bg-primary text-white font-medium rounded-lg hover:bg-primary-hover focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary transition-colors">
                        <i class="bi bi-upload mr-2"></i>
                        데이터 업로드 시작
                    </button>
                </form>

                <!-- 진행률 표시 -->
                <div id="uploadProgress" class="hidden mt-6">
                    <div class="flex items-center mb-2">
                        <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-primary mr-3"></div>
                        <span class="text-sm text-gray-600">업로드 진행 중...</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-2">
                        <div class="bg-primary h-2 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                    <p class="text-xs text-gray-500 mt-2">대용량 파일의 경우 시간이 오래 걸릴 수 있습니다.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- 업로드 가이드 -->
    <div class="lg:col-span-1 space-y-6">
        <!-- 필요한 컬럼 정보 -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="bi bi-question-circle mr-2"></i>필요한 컬럼 정보
                </h3>
            </div>
            <div class="p-6">
                <div class="space-y-2 text-sm">
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-700">고객명</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">필수</span>
                    </div>
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-700">휴대전화</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">필수</span>
                    </div>
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-700">차량번호</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">필수</span>
                    </div>
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-700">차량명</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">선택</span>
                    </div>
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-700">모델명</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">선택</span>
                    </div>
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-700">검사만료일</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">권장</span>
                    </div>
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-700">고객등급</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">선택</span>
                    </div>
                    <div class="flex justify-between items-center py-1">
                        <span class="text-gray-700">방문수</span>
                        <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">선택</span>
                    </div>
                </div>
                <div class="mt-4 p-3 bg-gray-50 rounded-lg">
                    <p class="text-xs text-gray-600">
                        <strong>참고:</strong> 컬럼명이 정확히 일치해야 합니다. 기존 엑셀 파일과 동일한 형식을 사용하세요.
                    </p>
                </div>
            </div>
        </div>

        <!-- 샘플 다운로드 -->
        <div class="bg-white rounded-lg shadow-sm">
            <div class="px-6 py-4 border-b border-gray-200">
                <h3 class="text-lg font-medium text-gray-900">
                    <i class="bi bi-download mr-2"></i>샘플 파일
                </h3>
            </div>
            <div class="p-6 text-center">
                <p class="text-sm text-gray-600 mb-4">올바른 형식의 샘플 파일을 다운로드하세요.</p>
                <button type="button" id="downloadSample"
                        class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-lg text-gray-700 bg-white hover:bg-gray-50 transition-colors">
                    <i class="bi bi-file-earmark-excel mr-2"></i>
                    샘플 엑셀 다운로드
                </button>
            </div>
        </div>
    </div>
</div>

<!-- 업로드 이력 -->
<div class="mt-8">
    <div class="bg-white rounded-lg shadow-sm">
        <div class="px-6 py-4 border-b border-gray-200">
            <h2 class="text-lg font-medium text-gray-900">
                <i class="bi bi-clock-history mr-2"></i>최근 업로드 이력
            </h2>
        </div>
        {% if upload_history %}
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">업로드 시간</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">파일명</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">업로드자</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">처리 결과</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">메모</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for history in upload_history %}
                    <tr class="hover:bg-gray-50">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ history.upload_date|date:"m/d" }}</div>
                            <div class="text-xs text-gray-500">{{ history.upload_date|date:"H:i" }}</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex items-center">
                                <i class="bi bi-file-earmark-excel text-green-600 mr-2"></i>
                                <span class="text-sm text-gray-900">{{ history.file_name }}</span>
                            </div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">{{ history.uploaded_by.username }}</td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="flex flex-wrap gap-1">
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">
                                    신규 {{ history.new_records }}건
                                </span>
                                <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-blue-100 text-blue-800">
                                    업데이트 {{ history.updated_records }}건
                                </span>
                                {% if history.error_count > 0 %}
                                    <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800">
                                        오류 {{ history.error_count }}건
                                    </span>
                                {% endif %}
                            </div>
                            <div class="text-xs text-gray-500 mt-1">총 {{ history.total_records }}건 처리</div>
                        </td>
                        <td class="px-6 py-4 text-sm text-gray-500">
                            {% if history.notes %}
                                <span class="truncate block max-w-xs" title="{{ history.notes }}">
                                    {{ history.notes }}
                                </span>
                            {% else %}
                                -
                            {% endif %}
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="text-center py-8">
            <i class="bi bi-inbox text-5xl text-gray-300"></i>
            <p class="mt-3 text-sm text-gray-500">아직 업로드 이력이 없습니다.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const fileInput = document.getElementById('id_file');
    const uploadForm = document.getElementById('uploadForm');
    const uploadBtn = document.getElementById('uploadBtn');
    const uploadProgress = document.getElementById('uploadProgress');
    const dropZone = document.getElementById('dropZone');
    const fileInfo = document.getElementById('fileInfo');

    // 파일 선택 시 정보 표시
    fileInput.addEventListener('change', function() {
        const file = this.files[0];
        if (file) {
            // 파일 크기 체크
            const maxSize = 10 * 1024 * 1024; // 10MB
            if (file.size > maxSize) {
                showToast('파일 크기가 10MB를 초과합니다.', 'error');
                this.value = '';
                fileInfo.classList.add('hidden');
                return;
            }
            
            // 파일 확장자 체크
            const allowedTypes = ['.xlsx', '.xls', '.csv'];
            const fileExtension = file.name.toLowerCase().substring(file.name.lastIndexOf('.'));
            if (!allowedTypes.includes(fileExtension)) {
                showToast('지원하지 않는 파일 형식입니다. Excel 또는 CSV 파일을 선택해주세요.', 'error');
                this.value = '';
                fileInfo.classList.add('hidden');
                return;
            }
            
            // 파일 정보 표시
            const fileSize = (file.size / 1024 / 1024).toFixed(2);
            fileInfo.innerHTML = `
                <i class="bi bi-file-earmark-check text-green-600 mr-1"></i>
                <strong>${file.name}</strong> (${fileSize}MB)
            `;
            fileInfo.classList.remove('hidden');
        } else {
            fileInfo.classList.add('hidden');
        }
    });

    // 드래그 앤 드롭 기능
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, preventDefaults, false);
    });

    function preventDefaults(e) {
        e.preventDefault();
        e.stopPropagation();
    }

    ['dragenter', 'dragover'].forEach(eventName => {
        dropZone.addEventListener(eventName, highlight, false);
    });

    ['dragleave', 'drop'].forEach(eventName => {
        dropZone.addEventListener(eventName, unhighlight, false);
    });

    function highlight() {
        dropZone.classList.add('border-primary', 'bg-blue-50');
    }

    function unhighlight() {
        dropZone.classList.remove('border-primary', 'bg-blue-50');
    }

    dropZone.addEventListener('drop', handleDrop, false);

    function handleDrop(e) {
        const dt = e.dataTransfer;
        const files = dt.files;
        
        if (files.length > 0) {
            fileInput.files = files;
            fileInput.dispatchEvent(new Event('change'));
        }
    }

    // 폼 제출 시 진행률 표시
    uploadForm.addEventListener('submit', function(e) {
        const file = fileInput.files[0];
        if (!file) {
            e.preventDefault();
            showToast('파일을 선택해주세요.', 'error');
            return;
        }

        // UI 업데이트
        uploadBtn.disabled = true;
        uploadBtn.innerHTML = '<i class="bi bi-arrow-repeat animate-spin mr-2"></i>업로드 중...';
        uploadProgress.classList.remove('hidden');
        
        // 가짜 진행률 애니메이션
        let progress = 0;
        const progressBar = uploadProgress.querySelector('.bg-primary');
        const interval = setInterval(() => {
            progress += Math.random() * 10;
            if (progress > 90) progress = 90;
            progressBar.style.width = progress + '%';
        }, 1000);
        
        // 실제 서버 응답을 기다리기 위해 interval을 전역에 저장
        window.uploadInterval = interval;
    });

    // 샘플 파일 다운로드
    document.getElementById('downloadSample').addEventListener('click', function(e) {
        e.preventDefault();
        
        // CSV 샘플 데이터 생성
        const sampleData = [
            ['고객명', '휴대전화', '차량번호', '차량명', '모델명', '검사만료일', '고객등급', '방문수'],
            ['김철수', '010-1234-5678', '01가1234', '소나타', 'DN8 2.0', '2025-12-31', 'VIP', '5'],
            ['이영희', '010-2345-6789', '02나5678', 'K5', '3세대 1.6T', '2026-06-15', '준회원', '2'],
            ['박민수', '010-3456-7890', '03다9012', '그랜저', 'IG 2.5', '2024-03-20', '정회원', '8']
        ];
        
        // CSV 문자열 생성
        const csvContent = sampleData.map(row => row.join(',')).join('\n');
        
        // 다운로드 실행
        const blob = new Blob(['\ufeff' + csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = 'autocare_sample.csv';
        link.click();
        URL.revokeObjectURL(link.href);
        
        showToast('샘플 파일을 다운로드했습니다.', 'success');
    });
});
</script>
{% endblock %}